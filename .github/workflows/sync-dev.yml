name: Sync Dev Branch

on:
  push:
    branches:
      - main

  pull_request: 
    types:
      - closed

  # Ê∑ªÂä†ÊâãÂä®Ëß¶Âèë‰∫ã‰ª∂
  workflow_dispatch:

jobs:
  sync-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Gives write access to repository contents
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ÂèØÈÄâÁöÑÂ§±Ë¥•ÊµãËØïÊ≠•È™§
      - name: Simulate failure (manual trigger)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "Simulating failure..."
          exit 1

      - name: Update dev branch
        id: sync
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout dev
          git merge main
          git push origin dev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Feishu notification on success
        if: success()
        run: |
          timestamp=$(date +%s)
          curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "config": { "wide_screen_mode": true },
              "header": {
                "title": { "tag": "plain_text", "content": "‚úÖ Dev Branch Sync Completed" },
                "template": "green"
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "‚úÖ **Dev Branch Sync Successful**\n\n**Repository:** ${{ github.repository }}\n**Workflow:** ${{ github.workflow }}\n**Triggered by:** ${{ github.actor }}\n**Event:** ${{ github.event_name }}\n\n[View Action Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                  }
                }
              ]
            }
          }'

      - name: Send Feishu notification on failure
        if: failure()
        run: |
          timestamp=$(date +%s)
          curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "config": { "wide_screen_mode": true },
              "header": {
                "title": { "tag": "plain_text", "content": "üö® Dev Branch Sync Failed" },
                "template": "red"
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "‚ùå **Dev Branch Sync Failed**\n\n**Repository:** ${{ github.repository }}\n**Workflow:** ${{ github.workflow }}\n**Triggered by:** ${{ github.actor }}\n**Event:** ${{ github.event_name }}\n\n[View Action Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                  }
                }
              ]
            }
          }'