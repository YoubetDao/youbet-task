name: Sync Main to Dev

on:
  pull_request: 
    branches:
      - main
    types:
      - closed

  # manual trigger
  workflow_dispatch:
    inputs:
      simulate_failure:
        description: 'Simulate failure for testing'
        required: false
        default: 'false'

jobs:
  sync-main-to-dev:
    if : github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Gives write access to repository contents
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update dev branch
        id: sync
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin dev
          git checkout dev
          git merge origin/main --no-ff -m "chore: sync main to dev"
          git push origin dev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Feishu notification on success
        if: ${{ success() && inputs.simulate_failure != 'true' }}
        run: |
          timestamp=$(date +%s)
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "config": { "wide_screen_mode": true },
              "header": {
                "title": { "tag": "plain_text", "content": "‚úÖ Dev Branch Sync Completed" },
                "template": "green"
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "üì¶ **Repository:** [${{ github.repository }}](github.com/${{ github.repository }})"
                  }
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "üîÑ **Workflow:** [${{ github.workflow }}](github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                  }
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "üöÄ **Triggered by:** ${{ github.actor }}"
                  }
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "üîî **Event:** ${{ github.event_name }}"
                  }
                },
                {
                    "tag": "action",
                    "actions": [
                        {
                            "tag": "button",
                            "text": {
                                "tag": "plain_text",
                                "content": "View Action Details"
                            },
                            "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                            "type": "primary"
                        }
                    ]
                }
              ]
            }
          }' \
          ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}

      - name: Send Feishu notification on failure
        if: ${{ failure() || inputs.simulate_failure == 'true' }}

        run: |
          timestamp=$(date +%s)
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "config": { "wide_screen_mode": true },
              "header": {
                "title": { "tag": "plain_text", "content": "‚ùå Dev Branch Sync Failed" },
                "template": "red"
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "üì¶ **Repository:** [${{ github.repository }}](github.com/${{ github.repository }})"
                  }
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "üîÑ **Workflow:** [${{ github.workflow }}](github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                  }
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "üöÄ **Triggered by:** ${{ github.actor }}"
                  }
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "üîî **Event:** ${{ github.event_name }}"
                  }
                },
                {
                    "tag": "action",
                    "actions": [
                        {
                            "tag": "button",
                            "text": {
                                "tag": "plain_text",
                                "content": "View Action Details"
                            },
                            "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                            "type": "primary"
                        }
                    ]
                }
              ]
            }
          }' \
          ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}